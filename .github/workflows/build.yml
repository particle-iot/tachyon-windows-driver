# Adapted from https://github.com/pbatard/libwdi/blob/master/.github/workflows/vs2022.yml
name: build

on:
  - push

env:
  WDK_URL: https://go.microsoft.com/fwlink/p/?LinkID=253170
  LIBUSB0_URL: https://github.com/mcuee/libusb-win32/releases/download/release_1.4.0.0/libusb-win32-bin-1.4.0.0.zip
  LIBUSBK_URL: https://github.com/mcuee/libusbk/releases/download/V3.1.0.0/libusbK-3.1.0.0-bin.7z
  SOLUTION_FILE_PATH: libwdi/libwdi.sln
  BUILD_MACROS: '"WDK_DIR=\"../wdk/Windows Kits/8.0\";LIBUSB0_DIR=\"../libusb0\";LIBUSBK_DIR=\"../libusbk/bin\""'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
    - name: Checkout libwdi
      uses: actions/checkout@v4
      with:
        repository: pbatard/libwdi
        ref: v1.5.1
        submodules: recursive
        path: libwdi

    - name: Download support files
      shell: cmd
      run: |
        curl -L ${{ env.WDK_URL }} -o wdk-redist.msi
        curl -L ${{ env.LIBUSB0_URL }} -o libusb0-redist.zip
        curl -L ${{ env.LIBUSBK_URL }} -o libusbk-redist.7z
        msiexec /a wdk-redist.msi /qn TARGETDIR=%CD%\libwdi\wdk
        7z x libusb0-redist.zip
        7z x libusbk-redist.7z
        del *.zip
        del *.7z
        move libusb-win32* libwdi\libusb0
        move libusbK* libwdi\libusbk
      
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Build
      shell: cmd
      run: |
        msbuild ${{ env.SOLUTION_FILE_PATH }} /m /p:Configuration=Release,Platform=Win32,BuildMacros=${{ env.BUILD_MACROS }}
